name: Run Test Script with Docker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  run-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ„å»º Docker é•œåƒ
      run: |
        echo "ğŸ³ æ„å»º Docker é•œåƒ..."
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„Dockerfileï¼Œä¸å¤åˆ¶é¡¹ç›®æ–‡ä»¶
        cat > docker/Dockerfile.temp << 'EOF'
        FROM ubuntu:20.04
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        ENV DEBIAN_FRONTEND=noninteractive
        ENV TZ=Asia/Shanghai
        
        # å®‰è£…ARMäº¤å‰ç¼–è¯‘å·¥å…·é“¾å’Œå¼€å‘å·¥å…·
        RUN apt-get update && apt-get install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf \
            qemu-user-static \
            qemu-user \
            make \
            vim \
            git \
            wget \
            pkg-config \
            libtool \
            autoconf \
            automake \
            && rm -rf /var/lib/apt/lists/*
        
        # å®‰è£… QuickJS
        RUN cd /tmp && \
            wget -q https://bellard.org/quickjs/quickjs-2021-03-27.tar.xz && \
            tar -xf quickjs-2021-03-27.tar.xz && \
            cd quickjs-2021-03-27 && \
            make && \
            mkdir -p /opt/quickjs && \
            cp quickjs.h /opt/quickjs/ && \
            cp quickjs-libc.h /opt/quickjs/ && \
            cp libquickjs.a /opt/quickjs/ && \
            cp qjs /opt/quickjs/ && \
            cp qjsc /opt/quickjs/ && \
            cd / && \
            rm -rf /tmp/quickjs-2021-03-27* && \
            echo "QuickJS å®‰è£…å®Œæˆ"
        
        # è®¾ç½®å·¥ä½œç›®å½•
        WORKDIR /workspace
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        ENV ARM_CC="arm-linux-gnueabihf-gcc"
        ENV ARM_CXX="arm-linux-gnueabihf-g++"
        ENV QUICKJS_ROOT="/opt/quickjs"
        ENV PATH="/opt/quickjs:$PATH"
        
        # é»˜è®¤å‘½ä»¤
        CMD ["/bin/bash"]
        EOF
        
        docker build -t alautotest:latest -f docker/Dockerfile.temp .
        echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ"
        
    - name: ç¼“å­˜ç¼–è¯‘äº§ç‰©
      uses: actions/cache@v3
      with:
        path: |
          demo_armv7
          demo
          demo_armv7_debug
          demo_debug
        key: docker-build-${{ runner.os }}-${{ hashFiles('main.c', 'run.sh', 'Makefile', 'test.js', 'docker/Dockerfile') }}
        restore-keys: |
          docker-build-${{ runner.os }}-
          
    - name: åœ¨ Docker å®¹å™¨ä¸­æ‰§è¡Œç¼–è¯‘
      run: |
        echo "ğŸš€ åœ¨ Docker å®¹å™¨ä¸­æ‰§è¡Œç¼–è¯‘..."
        echo "----------------------------------------"
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç¼–è¯‘
        if [ -f "demo_armv7" ]; then
          echo "âœ… å‘ç°ç¼“å­˜çš„ç¼–è¯‘äº§ç‰©ï¼Œè·³è¿‡ç¼–è¯‘"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file demo_armv7
          echo "æ–‡ä»¶å¤§å°: $(stat -c%s demo_armv7) å­—èŠ‚"
        else
          echo "ğŸ”„ ç¼“å­˜æœªå‘½ä¸­ï¼Œåœ¨ Docker å®¹å™¨ä¸­ç¼–è¯‘..."
          
          # åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œç¼–è¯‘
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            alautotest:latest \
            bash -c "
              echo 'è®¾ç½®ç¯å¢ƒå˜é‡...'
              export ARM_CC='arm-linux-gnueabihf-gcc'
              export ARM_CXX='arm-linux-gnueabihf-g++'
              export QUICKJS_ROOT='/opt/quickjs'
              export PATH='/opt/quickjs:$PATH'
              
              echo 'è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™...'
              chmod +x run.sh build.sh dev.sh test_quickjs.sh tmp_install_quickjs.sh
              
              echo 'å¼€å§‹ç¼–è¯‘ ARMv7 ç‰ˆæœ¬...'
              echo 'å½“å‰ç›®å½•å†…å®¹:'
              ls -la
              echo 'run.sh å†…å®¹é¢„è§ˆ:'
              head -10 run.sh
              echo 'æ‰§è¡Œç¼–è¯‘...'
              ./run.sh --arm
              
              echo 'ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥ç»“æœ...'
              ls -la demo*
              echo 'æ–‡ä»¶ç±»å‹æ£€æŸ¥:'
              file demo* 2>/dev/null || echo 'æ— demoæ–‡ä»¶'
              echo 'æŸ¥æ‰¾æ‰€æœ‰demoæ–‡ä»¶:'
              find . -name "demo*" -type f 2>/dev/null || echo 'æœªæ‰¾åˆ°demoæ–‡ä»¶'
            "
        fi
        echo "----------------------------------------"
        echo "âœ… Docker å®¹å™¨ç¼–è¯‘å®Œæˆ"
        
    - name: éªŒè¯è¾“å‡ºæ–‡ä»¶
      run: |
        echo "ğŸ” éªŒè¯ç¼–è¯‘è¾“å‡º..."
        if [ -f "demo_armv7" ]; then
          echo "âœ… ARMv7ç‰ˆæœ¬éªŒè¯æˆåŠŸ: demo_armv7"
          echo "æ–‡ä»¶å¤§å°: $(stat -c%s demo_armv7) å­—èŠ‚"
          file demo_armv7
          echo "æ¶æ„ä¿¡æ¯:"
          readelf -h demo_armv7 | grep -E "(Machine|Class|Data)"
          
          # å¿«é€Ÿæµ‹è¯•è¿è¡Œ
          echo "ğŸš€ å¿«é€Ÿæµ‹è¯•è¿è¡Œ..."
          timeout 10s qemu-arm -L /usr/arm-linux-gnueabihf demo_armv7 || {
            local exit_code=$?
            if [ $exit_code -eq 124 ]; then
              echo "âš ï¸  æµ‹è¯•è¿è¡Œè¶…æ—¶ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰"
            else
              echo "âœ… æµ‹è¯•è¿è¡Œå®Œæˆï¼Œé€€å‡ºç : $exit_code"
            fi
          }
        else
          echo "âŒ ARMv7ç‰ˆæœ¬éªŒè¯å¤±è´¥: demo_armv7 æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
        if [ -f "demo" ]; then
          echo "âœ… æœ¬åœ°ç‰ˆæœ¬éªŒè¯æˆåŠŸ: demo"
          echo "æ–‡ä»¶å¤§å°: $(stat -c%s demo) å­—èŠ‚"
          file demo
        else
          echo "âš ï¸  æœ¬åœ°ç‰ˆæœ¬æœªç¼–è¯‘ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸»è¦ç¼–è¯‘ARMv7ç‰ˆæœ¬ï¼‰"
        fi
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: docker-build-artifacts
        path: |
          demo
          demo_armv7
          demo_debug
          demo_armv7_debug
        retention-days: 7
        
    - name: æ˜¾ç¤ºæµ‹è¯•ç»“æœæ‘˜è¦
      run: |
        echo "ğŸ‰ Docker å®¹å™¨ç¼–è¯‘æµ‹è¯•å®Œæˆ!"
        echo "ğŸ“Š æµ‹è¯•ç»“æœ:"
        echo "  - Docker é•œåƒæ„å»º: âœ… æˆåŠŸ"
        echo "  - å®¹å™¨å†…ç¼–è¯‘: âœ… æˆåŠŸ"
        echo "  - ARMv7 ç‰ˆæœ¬: âœ… æˆåŠŸ"
        echo ""
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -la demo* 2>/dev/null || echo "æ— ç”Ÿæˆæ–‡ä»¶"
        echo ""
        echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!" 