# æ³¨æ„: æ­¤workflowå·²è¢« run-test.yml æ›¿ä»£
# æ–°çš„workflowç›´æ¥æ‰§è¡Œ run.sh è„šæœ¬è¿›è¡Œæµ‹è¯•
# å¦‚éœ€ä½¿ç”¨æ­¤workflowï¼Œè¯·æ‰‹åŠ¨è§¦å‘æˆ–ä¿®æ”¹è§¦å‘å™¨

name: Build, Test and Debug ARMv7 Binary

# å·²ç¦ç”¨ - ä½¿ç”¨ run-test.yml æ›¿ä»£
# on:
#   push:
#     branches: [ main, master ]
#   pull_request:
#     branches: [ main, master ]
#   workflow_dispatch:
#     inputs:
#       debug_mode:
#         description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
#         required: false
#         default: 'false'
#         type: boolean

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # è®¾ç½®è¶…æ—¶æ—¶é—´
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: å®‰è£…ARMäº¤å‰ç¼–è¯‘å·¥å…·é“¾
      run: |
        sudo apt-get update -qq  # é™é»˜æ›´æ–°
        sudo apt-get install -y --no-install-recommends \
          gcc-arm-linux-gnueabihf \
          g++-arm-linux-gnueabihf \
          qemu-user-static \
          binutils-arm-linux-gnueabihf
        
    - name: éªŒè¯å·¥å…·é“¾å®‰è£…
      run: |
        arm-linux-gnueabihf-gcc --version | head -1
        qemu-arm --version | head -1
        echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
        
    - name: ç¼–è¯‘ARMv7äºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
        make clean
        make demo_armv7
        echo "âœ… ç¼–è¯‘å®Œæˆ"
        
    - name: å¿«é€ŸéªŒè¯
      run: |
        echo "ğŸ” éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶..."
        file demo_armv7
        echo "æ–‡ä»¶å¤§å°: $(stat -c%s demo_armv7) å­—èŠ‚"
        
    - name: å¿«é€Ÿæµ‹è¯•æ‰§è¡Œ
      run: |
        echo "ğŸš€ æµ‹è¯•æ‰§è¡Œ..."
        chmod +x demo_armv7
        timeout 30s qemu-arm -L /usr/arm-linux-gnueabihf demo_armv7 || echo "æ‰§è¡Œå®Œæˆ"
        
    - name: è°ƒè¯•æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
      if: ${{ github.event.inputs.debug_mode == 'true' }}
      run: |
        echo "ğŸ› è°ƒè¯•æ¨¡å¼..."
        echo "ç¨‹åºå¤§å°: $(stat -c%s demo_armv7) å­—èŠ‚"
        readelf -h demo_armv7 | grep -E "(Machine|Class|Data)"
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
        mkdir -p release
        cp demo_armv7 release/
        cp main.c release/
        cp Makefile release/
        echo "æ„å»ºæ—¶é—´: $(date)" > release/build_info.txt
        echo "Gitæäº¤: ${{ github.sha }}" >> release/build_info.txt
        echo "ç›®æ ‡æ¶æ„: ARMv7" >> release/build_info.txt
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: armv7-binary
        path: release/
        retention-days: 30
        
    - name: æ˜¾ç¤ºç»“æœæ‘˜è¦
      run: |
        echo "ğŸ‰ æ„å»ºå®Œæˆ!"
        echo "ğŸ“ äº§ç‰©: release/"
        echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(stat -c%s demo_armv7) å­—èŠ‚"
        echo "âœ… çŠ¶æ€: æˆåŠŸ" 